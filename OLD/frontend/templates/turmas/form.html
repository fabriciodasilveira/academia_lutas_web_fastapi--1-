{% extends "base.html" %}

{% block title %}
{% if turma %}Editar Turma{% else %}Nova Turma{% endif %} - Academia de Lutas
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-users-cog me-2"></i>
                {% if turma %}Editar Turma{% else %}Nova Turma{% endif %}
            </h1>
            <a href="{{ url_for('turmas_list') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>
                Voltar
            </a>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Informações da Turma
                </h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('turmas_salvar') }}" method="POST">
                    {% if turma %}
                    <input type="hidden" name="id" value="{{ turma.id }}">
                    {% endif %}
                    
                    <div class="row g-3">
                        <!-- Nome da Turma -->
                        <div class="col-md-6">
                            <label for="nome" class="form-label">
                                <i class="fas fa-users-cog me-1"></i>
                                Nome da Turma *
                            </label>
                            <input type="text" class="form-control" id="nome" name="nome" 
                                   value="{{ turma.nome if turma else '' }}" required
                                   placeholder="Ex: Jiu-Jitsu Iniciante - Manhã">
                        </div>

                        <!-- Modalidade -->
                        <div class="col-md-6">
                            <label for="modalidade" class="form-label">
                                <i class="fas fa-medal me-1"></i>
                                Modalidade *
                            </label>
                            <select class="form-select" id="modalidade" name="modalidade" required>
                                <option value="">Selecione uma modalidade</option>
                                <option value="jiu-jitsu" {% if turma and turma.modalidade == 'jiu-jitsu' %}selected{% endif %}>Jiu-Jitsu</option>
                                <option value="muay-thai" {% if turma and turma.modalidade == 'muay-thai' %}selected{% endif %}>Muay Thai</option>
                                <option value="boxe" {% if turma and turma.modalidade == 'boxe' %}selected{% endif %}>Boxe</option>
                                <option value="mma" {% if turma and turma.modalidade == 'mma' %}selected{% endif %}>MMA</option>
                                <option value="karate" {% if turma and turma.modalidade == 'karate' %}selected{% endif %}>Karatê</option>
                                <option value="taekwondo" {% if turma and turma.modalidade == 'taekwondo' %}selected{% endif %}>Taekwondo</option>
                                <option value="judo" {% if turma and turma.modalidade == 'judo' %}selected{% endif %}>Judô</option>
                            </select>
                        </div>

                        <!-- Professor -->
                        <div class="col-md-6">
                            <label for="professor_id" class="form-label">
                                <i class="fas fa-chalkboard-teacher me-1"></i>
                                Professor
                            </label>
                            <select class="form-select" id="professor_id" name="professor_id">
                                <option value="">Selecione um professor</option>
                                {% for professor in professores %}
                                <option value="{{ professor.id }}" 
                                        {% if turma and turma.professor_id == professor.id %}selected{% endif %}>
                                    {{ professor.nome }} - {{ professor.especialidade|title if professor.especialidade else 'Sem especialidade' }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Nível -->
                        <div class="col-md-6">
                            <label for="nivel" class="form-label">
                                <i class="fas fa-layer-group me-1"></i>
                                Nível
                            </label>
                            <select class="form-select" id="nivel" name="nivel">
                                <option value="">Selecione o nível</option>
                                <option value="iniciante" {% if turma and turma.nivel == 'iniciante' %}selected{% endif %}>Iniciante</option>
                                <option value="intermediario" {% if turma and turma.nivel == 'intermediario' %}selected{% endif %}>Intermediário</option>
                                <option value="avancado" {% if turma and turma.nivel == 'avancado' %}selected{% endif %}>Avançado</option>
                                <option value="misto" {% if turma and turma.nivel == 'misto' %}selected{% endif %}>Misto</option>
                            </select>
                        </div>

                        <!-- Horário -->
                        <div class="col-md-6">
                            <label for="horario" class="form-label">
                                <i class="fas fa-clock me-1"></i>
                                Horário
                            </label>
                            <input type="text" class="form-control" id="horario" name="horario" 
                                   value="{{ turma.horario if turma else '' }}"
                                   placeholder="Ex: Segunda e Quarta 19:00-20:30">
                        </div>

                        <!-- Capacidade Máxima -->
                        <div class="col-md-6">
                            <label for="capacidade_maxima" class="form-label">
                                <i class="fas fa-users me-1"></i>
                                Capacidade Máxima
                            </label>
                            <input type="number" class="form-control" id="capacidade_maxima" name="capacidade_maxima" 
                                   value="{{ turma.capacidade_maxima if turma else '' }}" 
                                   min="1" max="50" placeholder="20">
                        </div>

                        <!-- Valor da Mensalidade -->
                        <div class="col-md-6">
                            <label for="valor_mensalidade" class="form-label">
                                <i class="fas fa-dollar-sign me-1"></i>
                                Valor da Mensalidade (R$)
                            </label>
                            <input type="number" class="form-control" id="valor_mensalidade" name="valor_mensalidade" 
                                   value="{{ turma.valor_mensalidade if turma else '' }}" 
                                   step="0.01" min="0" placeholder="150.00">
                        </div>

                        <!-- Idade Mínima -->
                        <div class="col-md-6">
                            <label for="idade_minima" class="form-label">
                                <i class="fas fa-child me-1"></i>
                                Idade Mínima
                            </label>
                            <input type="number" class="form-control" id="idade_minima" name="idade_minima" 
                                   value="{{ turma.idade_minima if turma else '' }}" 
                                   min="3" max="100" placeholder="16">
                        </div>

                        <!-- Status -->
                        <div class="col-md-6">
                            <label for="ativa" class="form-label">
                                <i class="fas fa-toggle-on me-1"></i>
                                Status
                            </label>
                            <select class="form-select" id="ativa" name="ativa">
                                <option value="1" {% if not turma or turma.ativa %}selected{% endif %}>Ativa</option>
                                <option value="0" {% if turma and not turma.ativa %}selected{% endif %}>Inativa</option>
                            </select>
                        </div>

                        <!-- Descrição -->
                        <div class="col-12">
                            <label for="descricao" class="form-label">
                                <i class="fas fa-align-left me-1"></i>
                                Descrição
                            </label>
                            <textarea class="form-control" id="descricao" name="descricao" rows="3" 
                                      placeholder="Descreva os objetivos e características da turma...">{{ turma.descricao if turma else '' }}</textarea>
                        </div>

                        <!-- Observações -->
                        <div class="col-12">
                            <label for="observacoes" class="form-label">
                                <i class="fas fa-sticky-note me-1"></i>
                                Observações
                            </label>
                            <textarea class="form-control" id="observacoes" name="observacoes" rows="2" 
                                      placeholder="Informações adicionais sobre a turma...">{{ turma.observacoes if turma else '' }}</textarea>
                        </div>
                    </div>

                    <!-- Botões -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="d-flex gap-2 justify-content-end">
                                <a href="{{ url_for('turmas_list') }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i>
                                    Cancelar
                                </a>
                                <button type="submit" class="btn btn-info">
                                    <i class="fas fa-save me-1"></i>
                                    {% if turma %}Atualizar{% else %}Cadastrar{% endif %}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Card de Dicas -->
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-header bg-transparent border-0">
                <h5 class="card-title mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    Dicas para Cadastro de Turmas
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-check-circle text-success me-2"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">Nome da Turma</h6>
                                <small class="text-muted">Use nomes descritivos que incluam modalidade, nível e período (ex: "Jiu-Jitsu Iniciante - Manhã")</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-check-circle text-success me-2"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">Horários</h6>
                                <small class="text-muted">Seja específico com dias e horários (ex: "Segunda e Quarta 19:00-20:30")</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-check-circle text-success me-2"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">Capacidade</h6>
                                <small class="text-muted">Considere o espaço físico e a qualidade do ensino ao definir a capacidade máxima</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-check-circle text-success me-2"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">Professor</h6>
                                <small class="text-muted">Associe professores com especialidade compatível com a modalidade da turma</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Validação do formulário
document.querySelector('form').addEventListener('submit', function(e) {
    const nome = document.getElementById('nome').value.trim();
    const modalidade = document.getElementById('modalidade').value;
    
    if (!nome) {
        e.preventDefault();
        alert('O nome da turma é obrigatório!');
        document.getElementById('nome').focus();
        return false;
    }
    
    if (!modalidade) {
        e.preventDefault();
        alert('A modalidade é obrigatória!');
        document.getElementById('modalidade').focus();
        return false;
    }
});

// Formatação do valor da mensalidade
document.getElementById('valor_mensalidade').addEventListener('blur', function(e) {
    const value = parseFloat(e.target.value);
    if (!isNaN(value)) {
        e.target.value = value.toFixed(2);
    }
});

// Filtrar professores por especialidade
document.getElementById('modalidade').addEventListener('change', function() {
    const modalidade = this.value;
    const professorSelect = document.getElementById('professor_id');
    const options = professorSelect.querySelectorAll('option');
    
    options.forEach(option => {
        if (option.value === '') {
            option.style.display = '';
            return;
        }
        
        const text = option.textContent.toLowerCase();
        if (!modalidade || text.includes(modalidade.replace('-', ' '))) {
            option.style.display = '';
        } else {
            option.style.display = 'none';
        }
    });
    
    // Reset selection if current option is hidden
    if (professorSelect.selectedOptions[0] && professorSelect.selectedOptions[0].style.display === 'none') {
        professorSelect.value = '';
    }
});

// Auto-sugerir nome da turma baseado na modalidade e nível
function updateTurmaNome() {
    const modalidade = document.getElementById('modalidade').value;
    const nivel = document.getElementById('nivel').value;
    const nomeInput = document.getElementById('nome');
    
    if (modalidade && nivel && !nomeInput.value.trim()) {
        const modalidadeFormatted = modalidade.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
        const nivelFormatted = nivel.charAt(0).toUpperCase() + nivel.slice(1);
        nomeInput.value = `${modalidadeFormatted} ${nivelFormatted}`;
    }
}

document.getElementById('modalidade').addEventListener('change', updateTurmaNome);
document.getElementById('nivel').addEventListener('change', updateTurmaNome);
</script>
{% endblock %}

