{% extends "base.html" %}

{% block title %}Dashboard Financeiro - Academia de Lutas{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-chart-line me-2"></i>
                Dashboard Financeiro
            </h1>
            <div class="d-flex gap-2">
                <a href="{{ url_for('financeiro_transacoes') }}" class="btn btn-outline-primary">
                    <i class="fas fa-list me-1"></i>
                    Ver Transações
                </a>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#novaTransacaoModal" onclick="if(typeof prepareModal==='function'){prepareModal('novo');}">
                    <i class="fas fa-plus me-1"></i>
                    Nova Transação
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-success bg-opacity-10 rounded-3 p-3">
                            <i class="fas fa-arrow-up text-success fa-2x"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="card-title text-muted mb-1">Receitas</h6>
                        <h3 class="mb-0 text-success">R$ {{ "%.2f"|format(stats.get('receitas', 0)) }}</h3>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0 pt-0">
                <small class="text-muted">
                    <i class="fas fa-calendar me-1"></i>
                    Este mês
                </small>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-danger bg-opacity-10 rounded-3 p-3">
                            <i class="fas fa-arrow-down text-danger fa-2x"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="card-title text-muted mb-1">Despesas</h6>
                        <h3 class="mb-0 text-danger">R$ {{ "%.2f"|format(stats.get('despesas', 0)) }}</h3>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0 pt-0">
                <small class="text-muted">
                    <i class="fas fa-calendar me-1"></i>
                    Este mês
                </small>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-{% if stats.get('saldo', 0) >= 0 %}primary{% else %}warning{% endif %} bg-opacity-10 rounded-3 p-3">
                            <i class="fas fa-wallet text-{% if stats.get('saldo', 0) >= 0 %}primary{% else %}warning{% endif %} fa-2x"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="card-title text-muted mb-1">Saldo</h6>
                        <h3 class="mb-0 text-{% if stats.get('saldo', 0) >= 0 %}primary{% else %}warning{% endif %}">
                            R$ {{ "%.2f"|format(stats.get('saldo', 0)) }}
                        </h3>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0 pt-0">
                <small class="text-muted">
                    <i class="fas fa-calculator me-1"></i>
                    Receitas - Despesas
                </small>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-info bg-opacity-10 rounded-3 p-3">
                            <i class="fas fa-exchange-alt text-info fa-2x"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="card-title text-muted mb-1">Transações</h6>
                        <h3 class="mb-0">{{ stats.get('total_transacoes', 0) }}</h3>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0 pt-0">
                <small class="text-muted">
                    <i class="fas fa-list me-1"></i>
                    Total registrado
                </small>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-area me-2"></i>
                    Fluxo de Caixa Mensal
                </h5>
            </div>
            <div class="card-body">
                <canvas id="fluxoCaixaChart" height="100"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Distribuição por Categoria
                </h5>
            </div>
            <div class="card-body">
                <canvas id="categoriaChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock me-2"></i>
                        Transações Recentes
                    </h5>
                    <a href="{{ url_for('financeiro_transacoes') }}" class="btn btn-outline-primary btn-sm">
                        Ver todas
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                {% if transacoes %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Data</th>
                                <th>Descrição</th>
                                <th>Categoria</th>
                                <th>Tipo</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transacao in transacoes %}
                            <tr>
                                <td>
                                    <div class="d-flex flex-column">
                                        <span class="fw-medium">
                                            {% if transacao.data %}
                                                {{ transacao.data.strftime('%d/%m/%Y') }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </span>
                                        <small class="text-muted">
                                            {% if transacao.data %}
                                                {{ transacao.data.strftime('%H:%M') }}
                                            {% endif %}
                                        </small>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            <div class="bg-{% if transacao.tipo == 'receita' %}success{% else %}danger{% endif %} bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                                                <i class="fas fa-{% if transacao.tipo == 'receita' %}arrow-up{% else %}arrow-down{% endif %} text-{% if transacao.tipo == 'receita' %}success{% else %}danger{% endif %}"></i>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <h6 class="mb-0">{{ transacao.descricao }}</h6>
                                            {% if transacao.observacoes %}
                                            <small class="text-muted">{{ transacao.observacoes[:50] }}...</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if transacao.categoria %}
                                    <span class="badge bg-secondary">{{ transacao.categoria }}</span>
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-{% if transacao.tipo == 'receita' %}success{% else %}danger{% endif %}">
                                        {% if transacao.tipo == 'receita' %}Receita{% else %}Despesa{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <span class="fw-bold text-{% if transacao.tipo == 'receita' %}success{% else %}danger{% endif %}">
                                        {% if transacao.tipo == 'receita' %}+{% else %}-{% endif %}R$ {{ "%.2f"|format(transacao.valor) }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhuma transação registrada</h5>
                    <p class="text-muted">Comece adicionando a primeira transação financeira.</p>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#novaTransacaoModal" onclick="prepareModal('novo')">
                        <i class="fas fa-plus me-1"></i>
                        Adicionar Primeira Transação
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="novaTransacaoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transacaoModalLabel">
                    <i class="fas fa-plus me-2"></i>
                    Nova Transação
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="transacaoForm" action="{{ url_for('financeiro_salvar_transacao') }}" method="POST">
                <input type="hidden" id="transacao_id" name="id">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="tipo" class="form-label">Tipo *</label>
                            <select class="form-select" id="tipo" name="tipo" required>
                                <option value="">Selecione o tipo</option>
                                <option value="receita">Receita</option>
                                <option value="despesa">Despesa</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="valor" class="form-label">Valor (R$) *</label>
                            <input type="number" class="form-control" id="valor" name="valor" 
                                   step="0.01" min="0" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="data" class="form-label">Data *</label>
                            <input type="date" class="form-control" id="data" name="data" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="categoria" class="form-label">Categoria *</label>
                            <select class="form-select" id="categoria" name="categoria" required>
                                <option value="">Selecione a categoria</option>
                                </select>
                        </div>
                        
                        <div class="col-md-8">
                            <label for="descricao" class="form-label">Descrição *</label>
                            <input type="text" class="form-control" id="descricao" name="descricao" required
                                   placeholder="Ex: Mensalidade João Silva - Janeiro/2024">
                        </div>
                        
                        <div class="col-md-4">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="confirmado">Confirmado</option>
                                <option value="pendente">Pendente</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                        
                        <div class="col-12">
                            <label for="observacoes" class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoes" name="observacoes" rows="3"
                                      placeholder="Informações adicionais sobre a transação..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="salvarTransacao()">
                    <i class="fas fa-save me-1"></i>
                    Salvar Transação
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir esta transação? Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="deleteTransacao()">Excluir</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>

const CATEGORIAS = {
    'receita': [
        { value: 'mensalidade', text: 'Mensalidade' },
        { value: 'matricula', text: 'Matrícula' },
        { value: 'evento', text: 'Evento' },
        { value: 'equipamento', text: 'Venda de Equipamento' },
        { value: 'outros', text: 'Outros' }
    ],
    'despesa': [
        { value: 'salarios', text: 'Salários' },
        { value: 'aluguel', text: 'Aluguel' },
        { value: 'equipamento', text: 'Compra de Equipamento' },
        { value: 'manutencao', text: 'Manutenção' },
        { value: 'outros', text: 'Outros' }
    ]
};

document.addEventListener('DOMContentLoaded', function() {
    // Dados dinâmicos do balanço
    const stats = {{ stats | tojson }};
    const transacoes = {{ transacoes | tojson }};
    
    // Lógica para os gráficos
    if (document.getElementById('fluxoCaixaChart')) {
        const ctxFluxo = document.getElementById('fluxoCaixaChart').getContext('2d');
        new Chart(ctxFluxo, {
            type: 'bar',
            data: {
                labels: ['Receitas', 'Despesas', 'Balanço'],
                datasets: [{
                    label: 'Valores (R$)',
                    data: [stats.receitas, stats.despesas, stats.saldo],
                    backgroundColor: ['#10b981', '#ef4444', '#2563eb'],
                    borderColor: ['#059669', '#dc2626', '#1d4ed8'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    if (document.getElementById('categoriaChart')) {
        const ctxCategoria = document.getElementById('categoriaChart').getContext('2d');
        const categoriasData = stats.graficos ? stats.graficos.categorias : {};
        const labels = Object.keys(categoriasData);
        const data = Object.values(categoriasData);

        new Chart(ctxCategoria, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                        '#3b82f6', '#6ee7b7', '#fcd34d', '#fca5a5', '#a78bfa'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    }

    const today = new Date().toISOString().split('T')[0];
    const dataInput = document.getElementById('data');
    if (dataInput) {
        dataInput.value = today;
    }

    // Lógica para preencher categorias no modal quando o tipo muda
    const tipoSelect = document.getElementById('tipo');
    const categoriaSelect = document.getElementById('categoria');
    
    function updateCategorias(selectedTipo) {
        categoriaSelect.innerHTML = '<option value="">Selecione a categoria</option>';
        if (CATEGORIAS[selectedTipo]) {
            CATEGORIAS[selectedTipo].forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.value;
                option.textContent = cat.text;
                categoriaSelect.appendChild(option);
            });
        }
    }
    
    tipoSelect.addEventListener('change', function() {
        updateCategorias(this.value);
    });
    
    updateCategorias(tipoSelect.value);

    const filterForm = document.getElementById('filterForm');
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const queryParams = new URLSearchParams(formData).toString();
            window.location.href = `{{ url_for("financeiro_transacoes") }}?${queryParams}`;
        });
    }

    const urlParams = new URLSearchParams(window.location.search);
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.value = urlParams.get('busca') || '';
    }
    document.getElementById('tipoFilter').value = urlParams.get('tipo') || '';
    document.getElementById('categoriaFilter').value = urlParams.get('categoria') || '';
    document.getElementById('dataInicioFilter').value = urlParams.get('data_inicio') || '';
    document.getElementById('dataFimFilter').value = urlParams.get('data_fim') || '';
    
    if (document.getElementById('tipoFilter').value) {
        const filterTipo = document.getElementById('tipoFilter').value;
        const filterCategoriaSelect = document.getElementById('categoriaFilter');
        const selectedCategoria = urlParams.get('categoria');
        
        filterCategoriaSelect.innerHTML = '<option value="">Todas categorias</option>';
        if (CATEGORIAS_RECEITA.concat(CATEGORIAS_DESPESA).some(c => c.value === selectedCategoria)) {
            let categorias = [];
            if (filterTipo === 'receita') {
                categorias = CATEGORIAS_RECEITA;
            } else if (filterTipo === 'despesa') {
                categorias = CATEGORIAS_DESPESA;
            } else {
                categorias = CATEGORIAS_RECEITA.concat(CATEGORIAS_DESPESA);
            }

            categorias.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.value;
                option.textContent = cat.text;
                if (cat.value === selectedCategoria) {
                    option.selected = true;
                }
                filterCategoriaSelect.appendChild(option);
            });
        }
    }
});

function prepareModal(mode, transacao = {}) {
    const modalLabel = document.getElementById('transacaoModalLabel');
    const form = document.getElementById('transacaoForm');
    const transacaoIdInput = document.getElementById('transacao_id');
    const tipoSelect = document.getElementById('tipo');
    
    if (mode === 'novo') {
        modalLabel.innerHTML = '<i class="fas fa-plus me-2"></i> Nova Transação';
        form.reset();
        transacaoIdInput.value = '';
        document.getElementById('data').value = new Date().toISOString().split('T')[0];
        document.getElementById('status').value = 'confirmado';
        
        tipoSelect.value = '';
        tipoSelect.dispatchEvent(new Event('change'));
    } else if (mode === 'editar') {
        modalLabel.innerHTML = '<i class="fas fa-edit me-2"></i> Editar Transação';
        transacaoIdInput.value = transacao.id;
        tipoSelect.value = transacao.tipo;
        tipoSelect.dispatchEvent(new Event('change'));
        document.getElementById('valor').value = transacao.valor;
        document.getElementById('data').value = transacao.data.split('T')[0];
        document.getElementById('categoria').value = transacao.categoria;
        document.getElementById('descricao').value = transacao.descricao;
        document.getElementById('observacoes').value = transacao.observacoes;
        document.getElementById('status').value = transacao.status;
    }
}

function salvarTransacao() {
    const form = document.getElementById('transacaoForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const formData = new FormData(form);
    const id = formData.get('id');
    
    let endpoint = '{{ url_for("financeiro_salvar_transacao") }}';
    if (id) {
        endpoint += `?id=${id}`;
    }

    fetch(endpoint, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw err; });
        }
        window.location.href = '{{ url_for("financeiro_dashboard") }}';
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar transação. Detalhes no console.');
        location.reload();
    });
}

function editTransacao(id) {
    fetch(`/api/v1/financeiro/transacoes/${id}`)
    .then(response => response.json())
    .then(transacao => {
        prepareModal('editar', transacao);
        const modal = new bootstrap.Modal(document.getElementById('novaTransacaoModal'));
        modal.show();
    })
    .catch(error => {
        console.error('Erro ao buscar transação para edição:', error);
        alert('Erro ao carregar dados da transação.');
    });
}

let transacaoToDelete = null;

function confirmDelete(id) {
    transacaoToDelete = id;
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

function deleteTransacao() {
    if (transacaoToDelete) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/financeiro/deletar_transacao/${transacaoToDelete}`;
        document.body.appendChild(form);
        form.submit();
    }
}

function clearFilters() {
    window.location.href = '{{ url_for("financeiro_transacoes") }}';
}
</script>
{% endblock %}