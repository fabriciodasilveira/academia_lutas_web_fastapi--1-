{% extends "base.html" %}

{% block title %}Transações - Academia de Lutas{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="fas fa-exchange-alt me-2"></i>
                Transações Financeiras
            </h1>
            <div class="btn-group">
                <a href="{{ url_for('financeiro_dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-chart-line me-1"></i>
                    Dashboard
                </a>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#novaTransacaoModal">
                    <i class="fas fa-plus me-1"></i>
                    Nova Transação
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Filtros e Busca -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" placeholder="Buscar transação..." id="searchInput">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="tipoFilter">
                            <option value="">Todos os tipos</option>
                            <option value="receita">Receita</option>
                            <option value="despesa">Despesa</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="categoriaFilter">
                            <option value="">Todas categorias</option>
                            <option value="mensalidade">Mensalidade</option>
                            <option value="matricula">Matrícula</option>
                            <option value="evento">Evento</option>
                            <option value="equipamento">Equipamento</option>
                            <option value="aluguel">Aluguel</option>
                            <option value="salario">Salário</option>
                            <option value="manutencao">Manutenção</option>
                            <option value="outros">Outros</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="date" class="form-control" id="dataInicioFilter" placeholder="Data início">
                    </div>
                    <div class="col-md-2">
                        <input type="date" class="form-control" id="dataFimFilter" placeholder="Data fim">
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()" title="Limpar Filtros">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resumo Rápido -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body">
                <div class="bg-success bg-opacity-10 rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                    <i class="fas fa-arrow-up fa-lg text-success"></i>
                </div>
                <h4 class="mb-0 text-success">R$ 15.750,00</h4>
                <small class="text-muted">Total Receitas</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body">
                <div class="bg-danger bg-opacity-10 rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                    <i class="fas fa-arrow-down fa-lg text-danger"></i>
                </div>
                <h4 class="mb-0 text-danger">R$ 8.200,00</h4>
                <small class="text-muted">Total Despesas</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body">
                <div class="bg-primary bg-opacity-10 rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                    <i class="fas fa-balance-scale fa-lg text-primary"></i>
                </div>
                <h4 class="mb-0 text-primary">R$ 7.550,00</h4>
                <small class="text-muted">Saldo</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body">
                <div class="bg-info bg-opacity-10 rounded-circle mx-auto mb-2 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                    <i class="fas fa-list fa-lg text-info"></i>
                </div>
                <h4 class="mb-0">{{ transacoes|length }}</h4>
                <small class="text-muted">Transações</small>
            </div>
        </div>
    </div>
</div>

<!-- Lista de Transações -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>
                    Histórico de Transações
                </h5>
            </div>
            <div class="card-body p-0">
                {% if transacoes %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Data</th>
                                <th>Descrição</th>
                                <th>Categoria</th>
                                <th>Tipo</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th width="120">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transacao in transacoes %}
                            <tr>
                                <td>
                                    <div class="d-flex flex-column">
                                        <span class="fw-medium">
                                            {% if transacao.data %}
                                                {{ transacao.data.strftime('%d/%m/%Y') }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </span>
                                        <small class="text-muted">
                                            {% if transacao.created_at %}
                                                {{ transacao.created_at.strftime('%H:%M') }}
                                            {% endif %}
                                        </small>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            {% if transacao.tipo == 'receita' %}
                                                <div class="bg-success bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                                                    <i class="fas fa-arrow-up text-success"></i>
                                                </div>
                                            {% else %}
                                                <div class="bg-danger bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                                                    <i class="fas fa-arrow-down text-danger"></i>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <h6 class="mb-0">{{ transacao.descricao }}</h6>
                                            {% if transacao.observacoes %}
                                            <small class="text-muted">{{ transacao.observacoes[:50] }}...</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if transacao.categoria %}
                                        <span class="badge bg-light text-dark">{{ transacao.categoria|title }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if transacao.tipo == 'receita' %}
                                        <span class="badge bg-success">Receita</span>
                                    {% else %}
                                        <span class="badge bg-danger">Despesa</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if transacao.tipo == 'receita' %}
                                        <span class="fw-bold text-success">+ R$ {{ "%.2f"|format(transacao.valor) }}</span>
                                    {% else %}
                                        <span class="fw-bold text-danger">- R$ {{ "%.2f"|format(transacao.valor) }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if transacao.status == 'confirmado' %}
                                        <span class="badge bg-success">Confirmado</span>
                                    {% elif transacao.status == 'pendente' %}
                                        <span class="badge bg-warning">Pendente</span>
                                    {% elif transacao.status == 'cancelado' %}
                                        <span class="badge bg-secondary">Cancelado</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary" onclick="viewTransacao({{ transacao.id }})" title="Visualizar">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="editTransacao({{ transacao.id }})" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="confirmDelete({{ transacao.id }})" title="Excluir">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-exchange-alt fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhuma transação encontrada</h5>
                    <p class="text-muted">Comece registrando a primeira transação financeira.</p>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#novaTransacaoModal">
                        <i class="fas fa-plus me-1"></i>
                        Registrar Primeira Transação
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal Nova Transação -->
<div class="modal fade" id="novaTransacaoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>
                    Nova Transação
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="transacaoForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="tipo" class="form-label">Tipo *</label>
                            <select class="form-select" id="tipo" name="tipo" required>
                                <option value="">Selecione o tipo</option>
                                <option value="receita">Receita</option>
                                <option value="despesa">Despesa</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="categoria" class="form-label">Categoria *</label>
                            <select class="form-select" id="categoria" name="categoria" required>
                                <option value="">Selecione a categoria</option>
                                <option value="mensalidade">Mensalidade</option>
                                <option value="matricula">Matrícula</option>
                                <option value="evento">Evento</option>
                                <option value="equipamento">Equipamento</option>
                                <option value="aluguel">Aluguel</option>
                                <option value="salario">Salário</option>
                                <option value="manutencao">Manutenção</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        
                        <div class="col-md-8">
                            <label for="descricao" class="form-label">Descrição *</label>
                            <input type="text" class="form-control" id="descricao" name="descricao" required
                                   placeholder="Ex: Mensalidade João Silva - Janeiro/2024">
                        </div>
                        
                        <div class="col-md-4">
                            <label for="valor" class="form-label">Valor (R$) *</label>
                            <input type="number" class="form-control" id="valor" name="valor" required
                                   step="0.01" min="0" placeholder="0,00">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="data" class="form-label">Data *</label>
                            <input type="date" class="form-control" id="data" name="data" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="confirmado">Confirmado</option>
                                <option value="pendente">Pendente</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                        
                        <div class="col-12">
                            <label for="observacoes" class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoes" name="observacoes" rows="3"
                                      placeholder="Informações adicionais sobre a transação..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="salvarTransacao()">
                    <i class="fas fa-save me-1"></i>
                    Salvar Transação
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir esta transação? Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="deleteTransacao()">Excluir</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let transacaoToDelete = null;

// Definir data atual como padrão
document.getElementById('data').valueAsDate = new Date();

function salvarTransacao() {
    const form = document.getElementById('transacaoForm');
    const formData = new FormData(form);
    
    // Validação básica
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Aqui você implementaria a chamada para salvar a transação
    console.log('Salvar transação:', Object.fromEntries(formData));
    
    // Fechar modal e recarregar página
    const modal = bootstrap.Modal.getInstance(document.getElementById('novaTransacaoModal'));
    modal.hide();
    location.reload();
}

function viewTransacao(id) {
    // Implementar visualização da transação
    console.log('Visualizar transação:', id);
}

function editTransacao(id) {
    // Implementar edição da transação
    console.log('Editar transação:', id);
}

function confirmDelete(id) {
    transacaoToDelete = id;
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

function deleteTransacao() {
    if (transacaoToDelete) {
        // Aqui você implementaria a chamada para deletar a transação
        console.log('Deletar transação:', transacaoToDelete);
        // Por enquanto, apenas recarrega a página
        location.reload();
    }
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('tipoFilter').value = '';
    document.getElementById('categoriaFilter').value = '';
    document.getElementById('dataInicioFilter').value = '';
    document.getElementById('dataFimFilter').value = '';
    // Aqui você implementaria a lógica para limpar os filtros
}

// Implementar busca em tempo real
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const descricao = row.cells[1].textContent.toLowerCase();
        const categoria = row.cells[2].textContent.toLowerCase();
        
        if (descricao.includes(searchTerm) || categoria.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Filtros
document.getElementById('tipoFilter').addEventListener('change', function() {
    const filterValue = this.value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        if (!filterValue) {
            row.style.display = '';
        } else {
            const tipo = row.cells[3].textContent.toLowerCase();
            if (tipo.includes(filterValue)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });
});

document.getElementById('categoriaFilter').addEventListener('change', function() {
    const filterValue = this.value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        if (!filterValue) {
            row.style.display = '';
        } else {
            const categoria = row.cells[2].textContent.toLowerCase();
            if (categoria.includes(filterValue)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });
});

// Formatação do valor
document.getElementById('valor').addEventListener('blur', function(e) {
    const value = parseFloat(e.target.value);
    if (!isNaN(value)) {
        e.target.value = value.toFixed(2);
    }
});

// Atualizar categorias baseado no tipo
document.getElementById('tipo').addEventListener('change', function() {
    const tipo = this.value;
    const categoriaSelect = document.getElementById('categoria');
    
    // Limpar opções atuais
    categoriaSelect.innerHTML = '<option value="">Selecione a categoria</option>';
    
    if (tipo === 'receita') {
        categoriaSelect.innerHTML += `
            <option value="mensalidade">Mensalidade</option>
            <option value="matricula">Matrícula</option>
            <option value="evento">Evento</option>
            <option value="equipamento">Venda de Equipamento</option>
            <option value="outros">Outros</option>
        `;
    } else if (tipo === 'despesa') {
        categoriaSelect.innerHTML += `
            <option value="aluguel">Aluguel</option>
            <option value="salario">Salário</option>
            <option value="equipamento">Compra de Equipamento</option>
            <option value="manutencao">Manutenção</option>
            <option value="outros">Outros</option>
        `;
    }
});
</script>
{% endblock %}

