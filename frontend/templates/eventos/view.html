{% extends "base.html" %}
{% block title %}Detalhes do Evento - {{ evento.nome }}{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">{{ evento.nome }}</h1>
    <div class="btn-group">
        <a href="{{ url_for('eventos_list') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Voltar
        </a>
        <a href="{{ url_for('eventos_editar', id=evento.id) }}" class="btn btn-warning">
            <i class="fas fa-edit me-1"></i>Editar Evento
        </a>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header bg-transparent border-0">
        <h5 class="mb-0">Inscrever Aluno</h5>
    </div>
    <div class="card-body">
        <form action="{{ url_for('eventos_inscrever') }}" method="POST">
            <input type="hidden" name="evento_id" value="{{ evento.id }}">
            <div class="input-group">
                <select class="form-select" name="aluno_id" required>
                    <option value="">Selecione o aluno...</option>
                    {% for aluno in alunos %}
                        <option value="{{ aluno.id }}">{{ aluno.nome }}</option>
                    {% endfor %}
                </select>
                <button class="btn btn-primary" type="submit">
                    <i class="fas fa-user-plus me-1"></i>Inscrever
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header bg-transparent border-0">
        <h5 class="mb-0">Inscritos ({{ inscricoes|length }} / {{ evento.capacidade if evento.capacidade > 0 else '∞' }})</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Aluno</th>
                        <th>Data Inscrição</th>
                        <th>Status</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inscricao in inscricoes %}
                    <tr>
                        <td>{{ inscricao.aluno.nome }}</td>
                        <td>{{ inscricao.data_inscricao | format_datetime }}</td>
                        <td>
                            {% if inscricao.status == 'pago' %}
                                <span class="badge bg-success">Pago</span>
                            {% elif inscricao.status == 'cancelado' %}
                                <span class="badge bg-secondary">Cancelado</span>
                            {% else %}
                                <span class="badge bg-warning">Pendente</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm" role="group">
                                {% if inscricao.status == 'pendente' and evento.valor_inscricao > 0 %}
                                    <form action="{{ url_for('inscricao_pagar_manual', id=inscricao.id) }}" method="POST" class="d-inline">
                                        <input type="hidden" name="evento_id" value="{{ evento.id }}">
                                        <button type="submit" class="btn btn-success" title="Confirmar Pagamento Manual">
                                            <i class="fas fa-cash-register"></i>
                                        </button>
                                    </form>
                                    <button class="btn btn-primary" onclick="pagarEventoOnline(event, {{ inscricao.id }})" title="Gerar Link de Pagamento Online">
                                        <i class="fas fa-credit-card"></i>
                                    </button>
                                {% endif %}
                                
                                {% if inscricao.status != 'cancelado' %}
                                <button class="btn btn-danger" onclick="confirmarCancelamento({{ inscricao.id }}, '{{ inscricao.aluno.nome }}', '{{ inscricao.status }}')" title="Cancelar Inscrição">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="cancelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="color:#000000">Confirmar Cancelamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p style="color:#000000">Tem certeza que deseja cancelar a inscrição do aluno <strong id="alunoNameToCancel"></strong>?</p>
                <div id="refundWarning" class="alert alert-warning" style="display: none;">
                    <strong>Atenção:</strong> Esta inscrição já foi paga. Ao cancelar, uma transação de estorno (despesa) será criada no seu relatório financeiro para representar a devolução do dinheiro.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Voltar</button>
                <button type="button" class="btn btn-danger" onclick="cancelarInscricao()">Confirmar Cancelamento</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let inscricaoToCancelId = null;

function confirmarCancelamento(id, nome, status) {
    inscricaoToCancelId = id;
    document.getElementById('alunoNameToCancel').textContent = nome;
    
    // Mostra o aviso de reembolso se a inscrição já estiver paga
    const refundWarning = document.getElementById('refundWarning');
    if (status === 'pago') {
        refundWarning.style.display = 'block';
    } else {
        refundWarning.style.display = 'none';
    }

    const modal = new bootstrap.Modal(document.getElementById('cancelModal'));
    modal.show();
}

function cancelarInscricao() {
    if (inscricaoToCancelId) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/inscricoes/${inscricaoToCancelId}/cancelar`;
        
        const eventoIdInput = document.createElement('input');
        eventoIdInput.type = 'hidden';
        eventoIdInput.name = 'evento_id';
        eventoIdInput.value = '{{ evento.id }}';
        form.appendChild(eventoIdInput);

        document.body.appendChild(form);
        form.submit();
    }
}

function pagarEventoOnline(event, inscricaoId) {
    const button = event.currentTarget;
    const originalHtml = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;

    fetch(`/inscricoes/${inscricaoId}/pagar-online`, {
        method: 'POST',
    })
    .then(response => {
        if (!response.ok) {
            // Tenta ler o erro do corpo da resposta
            return response.json().then(err => { throw err; });
        }
        return response.json();
    })
    .then(data => {
        if (data.init_point) {
            window.location.href = data.init_point;
        } else {
            alert(data.error || 'Erro ao gerar o link de pagamento.');
            button.innerHTML = originalHtml;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert(error.error || 'Ocorreu um erro inesperado. Verifique o console.');
        button.innerHTML = originalHtml;
        button.disabled = false;
    });
}
</script>
{% endblock %}